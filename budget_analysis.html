<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="BCCA Budget Analysis - Interactive comparison of 2025 Approved vs 2026 Proposed budgets with detailed variance analysis">
    <link rel="preconnect" href="https://cdn.plot.ly">
    <title>BCCA Budget Analysis Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f9; color: #333; }
        
        /* NEW: Simple Back Navigation Bar */
        .nav-bar { background-color: #34495e; padding: 10px 20px; display: flex; align-items: center; }
        .nav-back-btn { text-decoration: none; color: #ecf0f1; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; transition: color 0.2s; }
        .nav-back-btn:hover { color: #3498db; }
        
        .header { background-color: #2c3e50; color: white; padding: 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
        .header h1 { margin: 0; font-size: 1.8rem; }
        .header p { margin: 5px 0 0; font-size: 0.9rem; opacity: 0.8; }
        
        /* Toggle Switch */
        .view-controls { margin-top: 15px; display: flex; justify-content: center; gap: 10px; align-items: center; }
        .toggle-label { font-size: 0.9rem; font-weight: 600; color: #bdc3c7; cursor: pointer; transition: color 0.3s; }
        .toggle-label.active { color: white; text-decoration: underline; text-underline-offset: 4px; }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #34495e; transition: .4s; border-radius: 24px; border: 1px solid #7f8c8d; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3498db; }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Tabs */
        .tab-container { max-width: 1200px; margin: 20px auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
        .tabs { display: flex; background-color: #ecf0f1; border-bottom: 1px solid #bdc3c7; }
        .tab-button { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-size: 1rem; font-weight: 600; color: #7f8c8d; transition: all 0.3s ease; }
        .tab-button:hover { background-color: #dfe6e9; color: #2c3e50; }
        .tab-button.active { background-color: white; color: #2c3e50; border-top: 4px solid #3498db; }
        
        /* Content */
        .tab-content { display: none; padding: 20px; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        .chart-container { width: 100%; height: 700px; margin-bottom: 30px; }
        .chart-half-container { width: 100%; height: 500px; margin-bottom: 30px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #3498db; }
        .stat-card-warning { border-color: #e74c3c; }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: #2c3e50; }
        .stat-label { font-size: 0.85rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="nav-bar">
    <a href="index.html" class="nav-back-btn">
        &#8592; Back to Portal
    </a>
</div>

<div class="header">
    <h1>BCCA Budget Analysis Dashboard</h1>
    <p>Interactive Financial Analysis for 2025 Approved vs. 2026 Proposed Budgets</p>
    
    <div class="view-controls">
        <span class="toggle-label active" id="lbl-currency" onclick="setMode('currency')">Currency ($)</span>
        <label class="switch">
            <input type="checkbox" id="viewModeToggle" onchange="toggleMode()">
            <span class="slider"></span>
        </label>
        <span class="toggle-label" id="lbl-percent" onclick="setMode('percent')">Percent (%)</span>
    </div>
</div>

<div class="tab-container">
    <div class="tabs">
        <button class="tab-button" onclick="openTab(event, 'tab-2025')">2025 Analysis (Baseline)</button>
        <button class="tab-button active" onclick="openTab(event, 'tab-2026')">2026 Analysis (Proposed)</button>
        <button class="tab-button" onclick="openTab(event, 'tab-compare')">Variance & Comparison</button>
    </div>

    <div id="tab-2025" class="tab-content">
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-val" id="stat-2025-total">$260,391</div><div class="stat-label">Total Net Assessment</div></div>
            <div class="stat-card"><div class="stat-val" id="stat-2025-res">$110,580</div><div class="stat-label">Reserves Contribution</div></div>
            <div class="stat-card"><div class="stat-val" id="stat-2025-util">$77,850</div><div class="stat-label">Utilities Cost</div></div>
        </div>
        <h3>2025 Budget Flow</h3>
        <div id="sankey-2025" class="chart-container"></div>
    </div>

    <div id="tab-2026" class="tab-content active">
        <div class="stats-grid">
            <div class="stat-card stat-card-warning"><div class="stat-val" id="stat-2026-total">$282,269</div><div class="stat-label">Total Net Assessment (+8.4%)</div></div>
            <div class="stat-card"><div class="stat-val" id="stat-2026-res">$117,105</div><div class="stat-label">Reserves Contribution</div></div>
            <div class="stat-card stat-card-warning"><div class="stat-val" id="stat-2026-util">$86,100</div><div class="stat-label">Utilities Cost</div></div>
        </div>
        <h3>2026 Proposed Budget Flow</h3>
        <div id="sankey-2026" class="chart-container"></div>
    </div>

    <div id="tab-compare" class="tab-content">
        <h3>Budget Increase Bridge (Waterfall)</h3>
        <p id="waterfall-desc">Tracking the $21,878 increase from 2025 to 2026 by category.</p>
        <div id="waterfall-chart" class="chart-half-container"></div>
        
        <h3>Departmental Comparison</h3>
        <div id="bar-chart" class="chart-half-container"></div>
    </div>
</div>

<script>
    // --- CONFIG & STATE ---
    let currentMode = 'currency'; // 'currency' or 'percent'
    const TOTAL_2025 = 260391;
    const TOTAL_2026 = 282269;

    // --- DATA DEFINITIONS ---
    
    // 2025 Data
    const rawFlows2025 = [
        [0, 3, 260391], [1, 3, 6061], [2, 3, 1300], // Sources
        [3, 4, 110580], [3, 5, 77850], [3, 6, 37010], [3, 7, 18935], [3, 8, 10927], [3, 9, 8350], [3, 10, 3150], [3, 11, 950], // Depts
        [5, 12, 24300], [5, 13, 25900], [5, 14, 20200], [5, 15, 7450], // Utils
        [6, 16, 33600], [6, 17, 2475], [6, 18, 935], // Fin
        [7, 19, 7000], [7, 20, 4860], [7, 21, 1600], [7, 22, 1500], [7, 23, 1150], [7, 24, 2825], // Maint
        [8, 25, 4792], [8, 26, 2500], [8, 27, 1500], [8, 28, 900], [8, 29, 1235], // Board
        [9, 30, 4425], [9, 31, 1000], [9, 32, 800], [9, 33, 600], [9, 34, 1525], // CH
        [10, 35, 1000], [10, 36, 500], [10, 37, 650], [10, 38, 1000], // Land
        [11, 39, 600], [11, 40, 350] // Meals
    ];
    
    const labels2025 = ["Member Dues", "Parking Income", "CH Donations", "Total Budget", "Reserves", "Utilities", "Finance", "Maintenance", "Board", "Common House", "Landscaping", "Meals", "Natural Gas", "Water & Sewer", "Electricity", "Trash & Recycling", "Insurance", "Review/Audit", "Other Finance", "Repairs & Unpred", "Grounds/Pest", "Gutter Clean", "Upper Stairs", "Sprinklers", "Other Maint", "Internet & Tech", "Legal", "Retreats", "Child Care", "Other Board", "Cleaning", "Repairs", "Supplies", "Furnishings", "Other CH", "Tree Trimming", "Tools", "Plants/Fert", "Other Land", "Celebrations", "Pantry"];

    // 2026 Data
    const rawFlows2026 = [
        [0, 3, 282269], [1, 3, 6121], [2, 3, 1350], 
        [3, 4, 117105], [3, 5, 86100], [3, 6, 38419], [3, 7, 21050], [3, 8, 12197], [3, 9, 8720], [3, 10, 5050], [3, 11, 1100],
        [5, 12, 28900], [5, 13, 27700], [5, 14, 21800], [5, 15, 7700],
        [6, 16, 34729], [6, 17, 2640], [6, 18, 1050],
        [7, 19, 11000], [7, 20, 4050], [7, 21, 2200], [7, 22, 2000], [7, 23, 1800],
        [8, 24, 5097], [8, 25, 2500], [8, 26, 1500], [8, 27, 1450], [8, 28, 1650],
        [9, 29, 4500], [9, 30, 1200], [9, 31, 850], [9, 32, 825], [9, 33, 1345],
        [10, 34, 3000], [10, 35, 850], [10, 36, 1200],
        [11, 37, 750], [11, 38, 350]
    ];
    
    const labels2026 = ["Member Dues", "Parking Fees", "CH Donations", "Total Budget", "Reserves", "Utilities", "Finance", "Maintenance", "Board", "Common House", "Landscaping", "Meals", "Natural Gas", "Water & Sewer", "Electricity", "Trash & Recycling", "Insurance", "Reserve Study", "Acctg & Misc", "Bldg Repairs & Unpred", "Grounds Maint", "Gutter Cleaning", "Sprinklers/Fire", "Other Maint", "Internet & Tech", "Legal", "Retreat", "Training", "Other Board", "Cleaning", "Repairs", "Supplies", "Furnishings", "Other CH", "Tree Trimming", "Plants & Soil", "Other Landscape", "Celebrations", "Pantry"];

    // Department Data for Comparison
    const depts = ["Reserves", "Utilities", "Finance", "Maintenance", "Board", "Common House", "Landscaping", "Meals"];
    const val2025 = [110580, 77850, 37010, 18935, 10927, 7050, 3150, 950];
    const val2026 = [117105, 86100, 38419, 21050, 12197, 7370, 5050, 1100];

    // Waterfall Bridge Data
    const wfCategories = ["2025 Budget", "Utilities", "Reserves", "Maintenance", "Landscaping", "Finance", "Board", "Other", "2026 Budget"];
    const wfValues = [260391, 8250, 6524, 2115, 1900, 1409, 1270, 410, 0]; // Last 0 is placeholder for total

    // --- LOGIC & HELPERS ---

    function toggleMode() {
        const toggle = document.getElementById('viewModeToggle');
        setMode(toggle.checked ? 'percent' : 'currency');
    }

    function setMode(mode) {
        currentMode = mode;
        const toggle = document.getElementById('viewModeToggle');
        toggle.checked = (mode === 'percent');

        // UI Updates
        document.getElementById('lbl-currency').className = mode === 'currency' ? 'toggle-label active' : 'toggle-label';
        document.getElementById('lbl-percent').className = mode === 'percent' ? 'toggle-label active' : 'toggle-label';

        updateStats();
        renderCharts();
    }

    function formatValue(val, total) {
        if (currentMode === 'percent') {
            return (val / total * 100).toFixed(1) + '%';
        }
        return '$' + val.toLocaleString();
    }

    function updateStats() {
        // Helper to update a specific stat card
        const updateStat = (id, val, total) => {
            document.getElementById(id).innerText = formatValue(val, total);
        };

        // 2025 Stats
        updateStat('stat-2025-total', TOTAL_2025, TOTAL_2025); // 100% or $260k
        updateStat('stat-2025-res', 110580, TOTAL_2025);
        updateStat('stat-2025-util', 77850, TOTAL_2025);

        // 2026 Stats
        updateStat('stat-2026-total', TOTAL_2026, TOTAL_2026);
        updateStat('stat-2026-res', 117105, TOTAL_2026);
        updateStat('stat-2026-util', 86100, TOTAL_2026);
        
        // Waterfall Desc
        const wfDesc = document.getElementById('waterfall-desc');
        wfDesc.innerText = currentMode === 'percent' 
            ? "Tracking the 8.4% total budget increase by category contribution."
            : "Tracking the $21,878 increase from 2025 to 2026 by category.";
    }

    function renderSankey(divId, labels, flows, totalBudget, colorScale) {
        // Prepare data based on mode
        const values = flows.map(f => {
            return currentMode === 'percent' ? (f[2] / totalBudget * 100) : f[2];
        });
        
        const suffix = currentMode === 'percent' ? '%' : '';
        const prefix = currentMode === 'percent' ? '' : '$';
        
        // If Percent Mode, we normalize formatting
        const template = currentMode === 'percent' 
            ? '%{value:.1f}%<br>%{source.label} → %{target.label}' 
            : '$%{value:,.0f}<br>%{source.label} → %{target.label}';

        const plotData = {
            type: "sankey",
            orientation: "h",
            valueformat: currentMode === 'percent' ? ".1f" : ",.0f",
            valuesuffix: suffix,
            node: {
                pad: 15, thickness: 20, line: { color: "black", width: 0.5 },
                label: labels,
                color: colorScale,
                hovertemplate: '%{label}<br>' + prefix + '%{value}' + suffix + '<extra></extra>' 
            },
            link: {
                source: flows.map(f => f[0]),
                target: flows.map(f => f[1]),
                value: values,
                hovertemplate: template + '<extra></extra>'
            }
        };
        Plotly.react(divId, [plotData], { margin: { l: 10, r: 10, t: 20, b: 20 }, font: { size: 12 } }, {responsive: true});
    }

    function renderCharts() {
        // Colors
        const colors2025 = ["#bdc3c7", "#95a5a6", "#95a5a6", "#7f8c8d", "#2ecc71", "#f1c40f", "#e67e22", "#e74c3c", "#3498db", "#9b59b6", "#1abc9c", "#34495e"];
        const colors2026 = ["#3498db", "#2980b9", "#2980b9", "#2c3e50", "#2ecc71", "#f1c40f", "#e67e22", "#e74c3c", "#3498db", "#9b59b6", "#1abc9c", "#34495e"];

        renderSankey('sankey-2025', labels2025, rawFlows2025, TOTAL_2025, colors2025);
        renderSankey('sankey-2026', labels2026, rawFlows2026, TOTAL_2026, colors2026);

        // Waterfall Logic
        let wfY = [];
        let wfText = [];
        
        if (currentMode === 'percent') {
            // Percent increase relative to Base Year (2025)
            // 2025 = 100%
            // Increase = 8.4% (Calculated as 21878 / 260391)
            // Components = ComponentVal / 260391 * 100
            
            const base = TOTAL_2025;
            wfY = [100, 8250/base*100, 6524/base*100, 2115/base*100, 1900/base*100, 1409/base*100, 1270/base*100, 410/base*100, 0];
            wfText = wfY.map((v, i) => i === 0 ? "100%" : (i === 8 ? "108.4%" : "+" + v.toFixed(1) + "%"));
            wfText[8] = "108.4%";
        } else {
            wfY = wfValues;
            wfText = wfValues.map((v, i) => i === 0 ? "$260k" : (i === 8 ? "$282k" : "+$" + v.toLocaleString()));
            wfText[8] = "$282,269";
        }

        const waterfallData = {
            type: "waterfall",
            x: wfCategories,
            text: wfText,
            measure: ["absolute", "relative", "relative", "relative", "relative", "relative", "relative", "relative", "total"],
            y: wfY,
            connector: { line: { color: "rgb(63, 63, 63)" } },
            decreasing: { marker: { color: "#2ecc71" } },
            increasing: { marker: { color: "#e74c3c" } },
            totals: { marker: { color: "#2c3e50" } },
            textposition: "outside"
        };
        
        const wfLayout = { 
            title: {text: ""}, 
            yaxis: { 
                title: currentMode === 'percent' ? "% of 2025 Budget" : "Amount ($)",
                range: currentMode === 'percent' ? [95, 115] : [250000, 290000] 
            } 
        };
        Plotly.react('waterfall-chart', [waterfallData], wfLayout, {responsive: true});

        // Bar Chart Logic
        let barY1 = val2025;
        let barY2 = val2026;
        
        if (currentMode === 'percent') {
            barY1 = val2025.map(v => v / TOTAL_2025 * 100);
            barY2 = val2026.map(v => v / TOTAL_2026 * 100);
        }

        const trace1 = { 
            x: depts, y: barY1, name: '2025', type: 'bar', marker: {color: '#bdc3c7'},
            text: barY1.map(v => currentMode === 'percent' ? v.toFixed(1)+'%' : '$'+(v/1000).toFixed(1)+'k'),
            textposition: 'auto'
        };
        const trace2 = { 
            x: depts, y: barY2, name: '2026', type: 'bar', marker: {color: '#2980b9'},
            text: barY2.map(v => currentMode === 'percent' ? v.toFixed(1)+'%' : '$'+(v/1000).toFixed(1)+'k'),
            textposition: 'auto'
        };
        
        Plotly.react('bar-chart', [trace1, trace2], { barmode: 'group', margin: {t:20} }, {responsive: true});
    }

    // Tab Switching
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; tabcontent[i].classList.remove("active"); }
        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) { tablinks[i].className = tablinks[i].className.replace(" active", ""); }
        document.getElementById(tabName).style.display = "block";
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.className += " active";
        window.dispatchEvent(new Event('resize'));
    }

    // Init
    updateStats();
    renderCharts();
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="BCCA Water Bill Analysis - 12-month tracking of water and sewer costs with consumption trends and cost breakdown">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <title>Water Bill Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f6f9; }
        /* Navbar Styling to match Portal */
        .navbar-custom { background: #2c3e50; }
        .navbar-brand { font-weight: bold; color: white !important; }
        .btn-back { color: #ecf0f1; border: 1px solid rgba(255,255,255,0.3); }
        .btn-back:hover { background: rgba(255,255,255,0.1); color: white; }
        
        .card { box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: none; margin-bottom: 30px; }
        .chart-container { position: relative; height: 700px; width: 100%; }
        .table-highlight-success { border-left: 5px solid #27ae60; }
        .table-highlight-warning { border-left: 5px solid #f1c40f; }
        .table-highlight-danger { border-left: 5px solid #e74c3c; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-custom mb-4">
    <div class="container">
        <a class="navbar-brand" href="index.html">
            <i class="bi bi-house-door-fill me-2"></i>Community Dashboard
        </a>
        <div class="ms-auto">
            <a href="index.html" class="btn btn-sm btn-back">
                <i class="bi bi-arrow-left me-1"></i> Back to Portal
            </a>
        </div>
    </div>
</nav>

<div class="container-fluid px-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="fw-bold text-dark">Water & Sewer Cost Analysis <span class="text-muted fw-light fs-5">| Nov 2024 - Oct 2025</span></h2>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold text-primary"><i class="bi bi-bar-chart-fill me-2"></i>Cost Composition Trend</h5>
                        <span class="badge bg-light text-dark border">Interactive 12-Month View</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
                <div class="card-footer bg-light text-muted small">
                    <i class="bi bi-info-circle-fill me-1"></i>
                    <strong>Key Insight:</strong> The "Winter Base" (Dec '24) proves indoor usage is low (~73 CCF). The Summer spike (Aug '25) to 186 CCF is driven by outdoor use, incurring heavy Sewer fees.
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header fw-bold bg-white border-bottom">
                    <i class="bi bi-table me-2"></i>Detailed Billing Data
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 text-center align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>Month</th>
                                    <th>Total Bill</th>
                                    <th>Usage (CCF)</th>
                                    <th>Sewer Vol. (Red)</th>
                                    <th>Water Vol. (Blue)</th>
                                    <th>Fixed Costs</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Populated dynamically from JSON -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function loadAndRenderData() {
        try {
            const response = await fetch('data/water-bills.json');
            if (!response.ok) {
                throw new Error(`Failed to load data: ${response.status}`);
            }
            const data = await response.json();
            const bills = data.bills;

            // Sort by month to ensure correct order
            bills.sort((a, b) => a.month.localeCompare(b.month));

            // Build arrays for chart
            const labels = bills.map(b => b.label);
            const consumptionData = bills.map(b => b.ccf);
            const sewerVol = bills.map(b => b.sewer_volume);
            const waterVol = bills.map(b => b.water_volume);
            const fixedCosts = bills.map(b => b.fixed_costs);

            // Update header with date range
            const firstMonth = bills[0]?.label || '';
            const lastMonth = bills[bills.length - 1]?.label || '';
            document.querySelector('h2 span').textContent = `| ${firstMonth} - ${lastMonth}`;

            // Render chart
            renderChart(labels, consumptionData, sewerVol, waterVol, fixedCosts);

            // Render table
            renderTable(bills);

        } catch (error) {
            console.error('Error loading water bill data:', error);
            document.querySelector('.container-fluid').innerHTML = `
                <div class="alert alert-danger m-4">
                    <h4>Error Loading Data</h4>
                    <p>${error.message}</p>
                    <p>Make sure to serve this page via HTTP (e.g., <code>python -m http.server</code>)</p>
                </div>
            `;
        }
    }

    function renderChart(labels, consumptionData, sewerVol, waterVol, fixedCosts) {
        const ctx = document.getElementById('mainChart').getContext('2d');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Consumption (CCF)',
                        data: consumptionData,
                        type: 'line',
                        borderColor: '#2c3e50',
                        borderWidth: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#2c3e50',
                        pointRadius: 6,
                        yAxisID: 'y_consumption',
                        tension: 0.2,
                        order: 0
                    },
                    {
                        label: 'Sewer Volume Charges ($)',
                        data: sewerVol,
                        backgroundColor: '#e74c3c',
                        stack: 'Stack 0',
                        order: 1
                    },
                    {
                        label: 'Water Volume Charges ($)',
                        data: waterVol,
                        backgroundColor: '#3498db',
                        stack: 'Stack 0',
                        order: 1
                    },
                    {
                        label: 'Fixed Fees ($)',
                        data: fixedCosts,
                        backgroundColor: '#95a5a6',
                        stack: 'Stack 0',
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top', labels: { font: { size: 14 } } },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            footer: (tooltipItems) => {
                                let total = 0;
                                tooltipItems.forEach((item) => {
                                    if (item.dataset.type !== 'line') total += item.parsed.y;
                                });
                                return 'Total Cost: $' + total.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { font: { size: 14, weight: 'bold' } } },
                    y: { stacked: true, position: 'left', title: { display: true, text: 'Cost ($)', font: { size: 16 } } },
                    y_consumption: { position: 'right', title: { display: true, text: 'Usage (CCF)', font: { size: 16 } }, grid: { drawOnChartArea: false } }
                }
            }
        });
    }

    function renderTable(bills) {
        const tbody = document.querySelector('table tbody');

        // Find min and max for highlighting
        const totals = bills.map(b => b.total);
        const minTotal = Math.min(...totals);
        const maxTotal = Math.max(...totals);

        // Generate rows
        const rows = bills.map(bill => {
            // Determine highlighting
            let rowClass = '';
            if (bill.total === minTotal) {
                rowClass = 'table-success table-highlight-success';
            } else if (bill.total === maxTotal) {
                rowClass = 'table-danger table-highlight-danger';
            }

            // Format month for display (convert 2024-11 label "Nov 24" to "Nov 2024")
            const [year, month] = bill.month.split('-');
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const displayMonth = `${monthNames[parseInt(month) - 1]} ${year}`;

            return `
                <tr class="${rowClass}">
                    <td>${displayMonth}</td>
                    <td>$${bill.total.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td>${bill.ccf}</td>
                    <td>$${bill.sewer_volume.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td>$${bill.water_volume.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td>$${bill.fixed_costs.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = rows;
    }

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', loadAndRenderData);
</script>

</body>
</html>